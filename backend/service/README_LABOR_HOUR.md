# 工时检查服务说明

## 🤔 为什么既需要 App 配置又需要 Webhook？

这是一个很好的问题！让我用图解说明：

### 📊 完整流程

```
┌─────────────────────────────────────────────────────────┐
│                    工时检查服务流程                      │
└─────────────────────────────────────────────────────────┘

第1步：读取多维表格数据 🔐
┌──────────────────────────────────────────┐
│  需要：app_id + app_secret               │
│  ─────────────────────────────────────   │
│  LaborHourChecker                        │
│    │                                     │
│    ├─→ FeishuClient(app_id, secret)     │
│    │                                     │
│    └─→ BitableAPI.check_users_filled()  │
│         │                                │
│         └─→ GET /bitable/records         │
│               ↓                          │
│         [ 多维表格数据 ]                  │
│         - 张三：已填写 ✅                 │
│         - 李四：未填写 ❌                 │
│         - 王五：已填写 ✅                 │
└──────────────────────────────────────────┘
              ↓
第2步：处理数据，生成报告 📈
┌──────────────────────────────────────────┐
│  统计：已填写 2人，未填写 1人             │
│  填写率：66.7%                           │
│  生成美观的卡片消息                      │
└──────────────────────────────────────────┘
              ↓
第3步：发送到飞书群组 📤
┌──────────────────────────────────────────┐
│  需要：webhook_url + webhook_secret      │
│  ─────────────────────────────────────   │
│  LaborHourPublisher                      │
│    │                                     │
│    ├─→ generate_signature(secret)       │
│    │                                     │
│    └─→ POST webhook_url                 │
│         └─→ 消息出现在群聊中 💬          │
└──────────────────────────────────────────┘
```

### 🔍 详细对比

| 配置项 | 用途 | 权限需求 | 获取方式 | 是否必需 |
|-------|------|---------|---------|---------|
| **app_id** | 读取Bitable | 需要应用权限 | 创建飞书应用 | ✅ 必需 |
| **app_secret** | 读取Bitable | 需要应用权限 | 创建飞书应用 | ✅ 必需 |
| **webhook_url** | 发送消息 | 无需特殊权限 | 添加群机器人 | ✅ 必需 |
| **webhook_secret** | 签名验证 | 无需特殊权限 | 添加群机器人 | ✅ 必需 |

### 💡 为什么这样设计？

#### 方案对比

**❌ 只用 Webhook（不可行）**
```
Webhook ──X──> 无法读取 Bitable 数据
           
❌ 问题：Webhook 只能发送消息，无法读取数据
```

**❌ 只用 App（复杂）**
```
App ──✓──> 读取 Bitable
    ──✓──> 发送消息（需要获取群ID、配置权限）
    
❌ 问题：需要额外配置消息发送权限，还要获取群聊ID
```

**✅ App + Webhook（最优）**
```
App      ──✓──> 读取 Bitable （专职干这个）
Webhook  ──✓──> 发送消息     （最简单的方式）

✅ 优点：各司其职，配置简单
```

### 🆚 与新闻服务对比

#### 新闻服务（只需 Webhook）
```
┌────────────────┐
│  爬取网络数据   │ ← 不需要飞书权限
└────────────────┘
        ↓
┌────────────────┐
│  AI处理        │
└────────────────┘
        ↓
┌────────────────┐
│  Webhook推送   │ ← 只需要webhook
└────────────────┘
```

#### 工时检查服务（需要 App + Webhook）
```
┌────────────────┐
│  读取Bitable   │ ← 需要 app_id + app_secret
└────────────────┘
        ↓
┌────────────────┐
│  统计处理      │
└────────────────┘
        ↓
┌────────────────┐
│  Webhook推送   │ ← 需要 webhook_url + secret
└────────────────┘
```

### 📝 配置示例

```json
{
  "feishu": {
    "app_id": "cli_a1b2c3d4",      // 👈 用来读取多维表格
    "app_secret": "ABC123DEF456"    // 👈 用来读取多维表格
  },
  "bitable": {
    "url": "https://xxx.feishu.cn/base/xxx?table=xxx&view=xxx"
  },
  "webhook": {
    "url": "https://open.feishu.cn/open-apis/bot/v2/hook/xxx",  // 👈 用来发送消息
    "secret": "WYDI1R5kaqfQ"                                     // 👈 用来发送消息
  }
}
```

### 🎯 总结

**简单回答**：
- ✅ **需要 app_id 和 app_secret**：因为要读取多维表格数据
- ✅ **需要 webhook**：因为要发送消息到群组
- 🎪 **两者配合**：各司其职，配置最简单

**类比**：
- App = 钥匙 🔑（打开多维表格的门）
- Webhook = 邮筒 📮（把消息投递到群组）
- 你需要两个都有！

### 🚀 快速配置

```bash
# 1. 创建配置文件
cp backend/config/labor_hour.example.json backend/config/labor_hour.json

# 2. 获取 app_id 和 app_secret
# 访问 https://open.feishu.cn/ 创建应用

# 3. 获取 webhook
# 在群里添加自定义机器人

# 4. 填写配置文件
# 编辑 labor_hour.json

# 5. 测试
python backend/playground/run_labor_hour_check.py
```

### ❓ 常见问题

**Q: 能否简化配置，只用一个？**
A: 不行。读取数据和发送消息是两个不同的操作，需要不同的认证方式。

**Q: 为什么不用 App 直接发送消息？**
A: 可以，但需要：
- 配置消息发送权限
- 获取群聊 ID（需要管理员权限）
- 处理更复杂的 API 调用

Webhook 更简单，群成员就能配置。

**Q: 其他项目能复用这个 App 吗？**
A: 可以！只要有权限读取多维表格，同一个 App 可以用在多个服务中。

---

更多信息请查看：
- [配置详细说明](../config/README_CONFIG.md)
- [Backend完整文档](../README.md)



