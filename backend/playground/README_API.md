# APIæ¥å£æµ‹è¯•æ–‡æ¡£

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨APIæœåŠ¡

```bash
cd /Users/forhheart/AIGC/Agent2IM
python backend/api/main.py
```

æœåŠ¡å°†åœ¨ `http://localhost:9000` å¯åŠ¨

### 2. æµ‹è¯•APIæ¥å£

ä½¿ç”¨ VS Code REST Client æ’ä»¶æ‰“å¼€ `test_api.http` æ–‡ä»¶ï¼Œç‚¹å‡»æ¥å£ä¸Šæ–¹çš„ "Send Request" æŒ‰é’®ã€‚

---

## ğŸ“‹ APIæ¥å£è¯´æ˜

### å·¥æ—¶æ£€æŸ¥æ¥å£

**æ¥å£åœ°å€:**
```
GET /feishu/labor_hour/{app_id}-{app_secret}/{group_chat_id}/{bitable_url}
```

**å‚æ•°è¯´æ˜:**

| å‚æ•° | ä½ç½® | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `app_id` | Path | âœ… | é£ä¹¦åº”ç”¨ID | `cli_a82e97f4de29501c` |
| `app_secret` | Path | âœ… | é£ä¹¦åº”ç”¨å¯†é’¥ | `nEoauWe1YEt5luG6J4Ij8cvlTZKb3po3` |
| `group_chat_id` | Path | âœ… | é£ä¹¦ç¾¤èŠID | `oc_xxxxxxxxxxxxx` |
| `bitable_url` | Path | âœ… | å¤šç»´è¡¨æ ¼å®Œæ•´URL | `https://xxx.feishu.cn/base/xxx?table=xxx&view=xxx` |
| `date` | Query | âŒ | æ£€æŸ¥æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ | `2025-09-30` |

**å®Œæ•´ç¤ºä¾‹:**
```
http://localhost:9000/feishu/labor_hour/cli_a82e97f4de29501c-nEoauWe1YEt5luG6J4Ij8cvlTZKb3po3/oc_xxx/https://uxkpl4cba3j.feishu.cn/base/UfDPbov0Eal3RpsWAEBcyfe1nAb?table=tbla3OuZeDczpqZx&view=vewGyZRz6D?date=2025-09-30
```

---

## ğŸ“Š è¿”å›ç»“æœ

### æˆåŠŸå“åº”ï¼ˆå·¥ä½œæ—¥ï¼‰

```json
{
  "status": "success",
  "is_holiday": false,
  "date": "2025-09-30",
  "result": {
    "all_filled": false,
    "total": 15,
    "filled": 10,
    "not_filled": 5,
    "fill_rate": "66.7%",
    "on_leave": [],
    "exception_day": ["æ»•å‡¯"]
  },
  "message_sent": true
}
```

### æˆåŠŸå“åº”ï¼ˆèŠ‚å‡æ—¥ï¼‰

```json
{
  "status": "success",
  "is_holiday": true,
  "message": "ğŸ‰ 2025-10-01 æ˜¯èŠ‚å‡æ—¥ï¼Œæ— éœ€æ£€æŸ¥å·¥æ—¶å¡«å†™",
  "date": "2025-10-01"
}
```

### é”™è¯¯å“åº”

```json
{
  "status": "error",
  "message": "é”™è¯¯è¯¦ç»†ä¿¡æ¯",
  "date": "2025-09-30"
}
```

---

## ğŸ”§ é…ç½®ç¾¤èŠID

### å¦‚ä½•è·å–ç¾¤èŠIDï¼Ÿ

**æ–¹å¼1: é€šè¿‡é£ä¹¦å¼€æ”¾å¹³å°**

1. ç™»å½• [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/)
2. è¿›å…¥ä½ çš„åº”ç”¨ â†’ åŠŸèƒ½é…ç½® â†’ æœºå™¨äºº
3. å°†æœºå™¨äººæ·»åŠ åˆ°ç›®æ ‡ç¾¤èŠ
4. åœ¨ç¾¤èŠä¸­å‘é€æ¶ˆæ¯ï¼ŒæŸ¥çœ‹webhookå›è°ƒæ—¥å¿—è·å– `chat_id`

**æ–¹å¼2: é€šè¿‡APIè·å–**

```bash
# è·å–æœºå™¨äººæ‰€åœ¨çš„ç¾¤èŠåˆ—è¡¨
curl -X GET \
  'https://open.feishu.cn/open-apis/im/v1/chats' \
  -H 'Authorization: Bearer YOUR_ACCESS_TOKEN'
```

**æ–¹å¼3: ä»webhookå›è°ƒè·å–**

å‘é€æ¶ˆæ¯åˆ°ç¾¤èŠæ—¶ï¼Œåœ¨webhookå›è°ƒæ•°æ®ä¸­å¯ä»¥æ‰¾åˆ°ï¼š
```json
{
  "event": {
    "message": {
      "chat_id": "oc_xxxxxxxxxxxxx"
    }
  }
}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤1: ä¿®æ”¹é…ç½®

ç¼–è¾‘ `test_api.http` æ–‡ä»¶ï¼Œä¿®æ”¹å˜é‡ï¼š

```
@group_chat_id = oc_your_actual_group_chat_id
```

### æ­¥éª¤2: å¯åŠ¨æœåŠ¡

```bash
cd /Users/forhheart/AIGC/Agent2IM
python backend/api/main.py
```

çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºè¡¨ç¤ºå¯åŠ¨æˆåŠŸï¼š
```
INFO:     Started server process [xxxxx]
INFO:     Uvicorn running on http://0.0.0.0:9000 (Press CTRL+C to quit)
```

### æ­¥éª¤3: æµ‹è¯•æ¥å£

**ä½¿ç”¨ VS Code REST Client:**
1. å®‰è£…æ’ä»¶: `REST Client` by Huachao Mao
2. æ‰“å¼€ `test_api.http`
3. ç‚¹å‡»æ¥å£ä¸Šæ–¹çš„ "Send Request"

**ä½¿ç”¨ curl:**
```bash
curl "http://localhost:9000/feishu/labor_hour/cli_a82e97f4de29501c-nEoauWe1YEt5luG6J4Ij8cvlTZKb3po3/oc_xxx/https://uxkpl4cba3j.feishu.cn/base/UfDPbov0Eal3RpsWAEBcyfe1nAb?table=tbla3OuZeDczpqZx&view=vewGyZRz6D"
```

**ä½¿ç”¨æµè§ˆå™¨:**

ç›´æ¥åœ¨æµè§ˆå™¨æ‰“å¼€URLï¼ˆéœ€è¦URLç¼–ç ï¼‰

### æ­¥éª¤4: æŸ¥çœ‹ç»“æœ

- âœ… æ§åˆ¶å°æ˜¾ç¤ºæ£€æŸ¥è¿‡ç¨‹
- âœ… é£ä¹¦ç¾¤èŠæ”¶åˆ°å¡ç‰‡æ¶ˆæ¯
- âœ… APIè¿”å›JSONç»“æœ

---

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯1: æ£€æŸ¥ä»Šå¤©çš„å¡«å†™æƒ…å†µ

```
GET /feishu/labor_hour/{app_id}-{app_secret}/{group_chat_id}/{bitable_url}
```

### åœºæ™¯2: æ£€æŸ¥æŒ‡å®šæ—¥æœŸ

```
GET /feishu/labor_hour/{app_id}-{app_secret}/{group_chat_id}/{bitable_url}?date=2025-09-30
```

### åœºæ™¯3: æ£€æŸ¥èŠ‚å‡æ—¥ï¼ˆåº”è¿”å›èŠ‚å‡æ—¥æç¤ºï¼‰

```
GET /feishu/labor_hour/{app_id}-{app_secret}/{group_chat_id}/{bitable_url}?date=2025-10-01
```

### åœºæ™¯4: æ£€æŸ¥å‘¨æœ«

```
GET /feishu/labor_hour/{app_id}-{app_secret}/{group_chat_id}/{bitable_url}?date=2025-10-25
```

### åœºæ™¯5: æ£€æŸ¥ä¾‹å¤–æ—¥æœŸï¼ˆå¦‚æ˜ŸæœŸäºŒ - æ»•å‡¯ï¼‰

```
GET /feishu/labor_hour/{app_id}-{app_secret}/{group_chat_id}/{bitable_url}?date=2025-10-07
```

---

## ğŸ“± é£ä¹¦ç¾¤èŠæ•ˆæœ

è°ƒç”¨APIåï¼Œç¾¤èŠä¼šæ”¶åˆ°å¦‚ä¸‹å¡ç‰‡æ¶ˆæ¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š å·¥æ—¶å¡«å†™æƒ…å†µ - 2025-09-30           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  âš ï¸ è¿˜æœ‰ 5 äººæœªå¡«å†™å·¥æ—¶                â”‚
â”‚                                         â”‚
â”‚  ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯:                           â”‚
â”‚  - åº”å¡«å†™äººæ•°: 15 äºº                    â”‚
â”‚  - å·²å¡«å†™: 10 äºº âœ…                     â”‚
â”‚  - æœªå¡«å†™: 5 äºº âŒ                      â”‚
â”‚  - å¡«å†™ç‡: 66.7%                        â”‚
â”‚                                         â”‚
â”‚  ğŸ“… ä¾‹å¤–æ—¥æœŸäººå‘˜ (1 äºº):                â”‚
â”‚    æ»•å‡¯                                  â”‚
â”‚                                         â”‚
â”‚  â— éœ€è¦æé†’çš„äººå‘˜:                      â”‚
â”‚    â€¢ åˆ˜å®‰è¥                              â”‚
â”‚    â€¢ éŸ©å®‡è½©                              â”‚
â”‚    â€¢ å¾ä¿Šæœ—                              â”‚
â”‚    â€¢ è€¿è•¾                                â”‚
â”‚    â€¢ çŸ³å›½è‰³                              â”‚
â”‚                                         â”‚
â”‚  â° æ£€æŸ¥æ—¶é—´: 2025-10-23 14:30:00      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¡«å†™ç‡: 66.7%                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹æœåŠ¡æ—¥å¿—

å¯åŠ¨æœåŠ¡åï¼Œæ§åˆ¶å°ä¼šæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼š

```
================================================================================
ğŸ“‹ å¼€å§‹æ£€æŸ¥å·¥æ—¶å¡«å†™æƒ…å†µ
   App ID: cli_a82e97f4de29501c
   ç¾¤èŠID: oc_xxx
   Bitable URL: https://xxx
   æ£€æŸ¥æ—¥æœŸ: 2025-09-30

ğŸ” æ­£åœ¨æ£€æŸ¥äººå‘˜å¡«å†™æƒ…å†µ...
ğŸ“‹ ä»é…ç½®æ–‡ä»¶è¯»å–äººå‘˜åå•...
ğŸ“… 2025-09-30 æ˜¯æ˜ŸæœŸäºŒ
  â„¹ï¸ æ»•å‡¯ åœ¨æ˜ŸæœŸäºŒæ— éœ€å¡«å†™ï¼ˆä¾‹å¤–æ—¥æœŸï¼‰
âœ… éœ€è¦æ£€æŸ¥ 15 åäººå‘˜

ğŸ“Š æ£€æŸ¥ç»“æœ:
   åº”å¡«å†™äººæ•°: 15
   å·²å¡«å†™: 10 äºº
   æœªå¡«å†™: 5 äºº
   å¡«å†™ç‡: 66.7%

âœ… æ¶ˆæ¯å·²å‘é€åˆ°ç¾¤èŠ
================================================================================
```

### 2. æ£€æŸ¥APIå“åº”

```bash
# ä½¿ç”¨ curl -v æŸ¥çœ‹è¯¦ç»†å“åº”
curl -v "http://localhost:9000/feishu/labor_hour/..."
```

### 3. éªŒè¯é…ç½®

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:9000/

# æŸ¥çœ‹å®šæ—¶ä»»åŠ¡çŠ¶æ€
curl http://localhost:9000/scheduler/status
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ç¾¤èŠæ”¶ä¸åˆ°æ¶ˆæ¯ï¼Ÿ

**æ£€æŸ¥é¡¹:**
1. âœ… ç¾¤èŠIDæ˜¯å¦æ­£ç¡®
2. âœ… æœºå™¨äººæ˜¯å¦å·²åŠ å…¥ç¾¤èŠ
3. âœ… åº”ç”¨æ˜¯å¦æœ‰å‘é€æ¶ˆæ¯æƒé™
4. âœ… æŸ¥çœ‹APIè¿”å›ç»“æœå’ŒæœåŠ¡æ—¥å¿—

### Q2: æ¥å£è¿”å›401é”™è¯¯ï¼Ÿ

**åŸå› :** åº”ç”¨å‡­è¯è¿‡æœŸæˆ–é”™è¯¯

**è§£å†³:**
1. æ£€æŸ¥ `app_id` å’Œ `app_secret` æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤åº”ç”¨æœªè¢«åœç”¨

### Q3: æ¥å£è¿”å›91402é”™è¯¯ï¼Ÿ

**åŸå› :** å¤šç»´è¡¨æ ¼ä¸å­˜åœ¨æˆ–æ— æƒé™

**è§£å†³:**
1. ç¡®è®¤ `bitable_url` æ˜¯å¦æ­£ç¡®
2. å°†åº”ç”¨æ·»åŠ ä¸ºå¤šç»´è¡¨æ ¼çš„åä½œè€…
3. æ£€æŸ¥åº”ç”¨æ˜¯å¦æœ‰ `bitable:app:readonly` æƒé™

### Q4: æ—¥æœŸå‚æ•°ä¸ç”Ÿæ•ˆï¼Ÿ

**æ£€æŸ¥:** URLç¼–ç é—®é¢˜

**æ­£ç¡®æ ¼å¼:**
```
?date=2025-09-30
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [BitableåŠŸèƒ½è¯´æ˜](./README_BITABLE.md)
- [è°ƒåº¦å™¨ä½¿ç”¨è¯´æ˜](./README_SCHEDULER.md)
- [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/)
- [FastAPIæ–‡æ¡£](https://fastapi.tiangolo.com/)

---

## ğŸ“ URLç¼–ç æ³¨æ„äº‹é¡¹

ç”±äºURLä¸­åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ `?`, `&`, `=`ï¼‰ï¼Œå»ºè®®ï¼š

1. **ä½¿ç”¨HTTPå·¥å…·** (REST Client, Postman) - è‡ªåŠ¨å¤„ç†ç¼–ç 
2. **æ‰‹åŠ¨ç¼–ç ** - ä½¿ç”¨åœ¨çº¿URLç¼–ç å·¥å…·
3. **curlå‘½ä»¤** - ä½¿ç”¨å¼•å·åŒ…è£¹URL

```bash
# æ­£ç¡® âœ…
curl "http://localhost:9000/feishu/labor_hour/..."

# é”™è¯¯ âŒ (& ä¼šè¢«shellè§£æ)
curl http://localhost:9000/feishu/labor_hour/...
```


