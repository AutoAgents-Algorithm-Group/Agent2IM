# å®¡æ‰¹äº‹ä»¶è®¢é˜…ä½¿ç”¨æŒ‡å—

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

å½“é£ä¹¦å®¡æ‰¹é€šè¿‡æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºè¯·å‡æ—¥å†äº‹ä»¶ï¼Œå®ç°å®¡æ‰¹ä¸æ—¥å†çš„è”åŠ¨ã€‚

## ğŸ¯ å·¥ä½œæµç¨‹

```
é£ä¹¦å®¡æ‰¹ â†’ å®¡æ‰¹é€šè¿‡ â†’ Webhook å›è°ƒ â†’ æå–è¯·å‡ä¿¡æ¯ â†’ åˆ›å»ºè¯·å‡æ—¥å†
```

## ğŸ”§ é…ç½®æ­¥éª¤

### 1. é…ç½®é£ä¹¦åº”ç”¨æƒé™

åœ¨é£ä¹¦å¼€æ”¾å¹³å°é…ç½®ä»¥ä¸‹æƒé™ï¼š

**å®¡æ‰¹æƒé™**:
- `approval:approval:readonly` - æŸ¥çœ‹å®¡æ‰¹åº”ç”¨
- `approval:instance` - è·å–å®¡æ‰¹å®ä¾‹è¯¦æƒ…

**æ—¥å†æƒé™**:
- `calendar:calendar` - ç®¡ç†æ—¥å†
- `calendar:timeoffevent:write` - åˆ›å»ºè¯·å‡æ—¥ç¨‹

### 2. é…ç½®äº‹ä»¶è®¢é˜…

åœ¨é£ä¹¦å¼€æ”¾å¹³å° â†’ äº‹ä»¶è®¢é˜… â†’ æ·»åŠ äº‹ä»¶ï¼š

**è®¢é˜…äº‹ä»¶**:
- `approval_instance` - å®¡æ‰¹å®ä¾‹çŠ¶æ€å˜æ›´

**è¯·æ±‚åœ°å€**:
```
https://your-domain.com/feishu/approval/callback
```

**åŠ å¯†æ–¹å¼**: ä¸åŠ å¯†ï¼ˆæˆ–æ ¹æ®éœ€è¦é…ç½®ï¼‰

### 3. éƒ¨ç½²æœåŠ¡

```bash
# éƒ¨ç½² API æœåŠ¡
docker compose -f docker/docker-compose.yml up -d
```

### 4. é…ç½®å®¡æ‰¹æ¨¡æ¿

åœ¨é£ä¹¦å®¡æ‰¹ä¸­åˆ›å»ºè¯·å‡å®¡æ‰¹æ¨¡æ¿ï¼Œç¡®ä¿åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

**å¿…éœ€å­—æ®µ**:
- è¯·å‡å¼€å§‹æ—¶é—´ï¼ˆæ—¥æœŸç±»å‹æˆ–æ—¥æœŸåŒºé—´ï¼‰
- è¯·å‡ç»“æŸæ—¶é—´ï¼ˆæ—¥æœŸç±»å‹ï¼‰
- è¯·å‡åŸå› ï¼ˆæ–‡æœ¬ç±»å‹ï¼Œå¯é€‰ï¼‰

**å­—æ®µ ID å»ºè®®**ï¼ˆä¾¿äºè‡ªåŠ¨è¯†åˆ«ï¼‰:
- `start_time` æˆ–åŒ…å« "å¼€å§‹" çš„å­—æ®µ
- `end_time` æˆ–åŒ…å« "ç»“æŸ" çš„å­—æ®µ
- `reason` æˆ–åŒ…å« "åŸå› " çš„å­—æ®µ

## ğŸ“¡ API æ¥å£

### å®¡æ‰¹äº‹ä»¶å›è°ƒ

**URL**: `POST /feishu/approval/callback`

**è¯´æ˜**: æ¥æ”¶é£ä¹¦å®¡æ‰¹äº‹ä»¶å›è°ƒ

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "type": "event_callback",
  "event_id": "xxx",
  "event": {
    "type": "approval_instance",
    "status": "APPROVED",
    "approval_code": "xxx",
    "instance_code": "xxx",
    "user_id": "ou_xxx",
    "open_id": "ou_xxx"
  }
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "msg": "success"
}
```

## ğŸ§ª æµ‹è¯•

### 1. URL éªŒè¯æµ‹è¯•

é£ä¹¦é¦–æ¬¡é…ç½® webhook æ—¶ä¼šå‘é€éªŒè¯è¯·æ±‚ï¼š

```bash
curl -X POST 'https://your-domain.com/feishu/approval/callback' \
-H 'Content-Type: application/json' \
-d '{
  "type": "url_verification",
  "challenge": "test_challenge"
}'
```

**æœŸæœ›å“åº”**:
```json
{
  "challenge": "test_challenge"
}
```

### 2. æ¨¡æ‹Ÿå®¡æ‰¹é€šè¿‡äº‹ä»¶

```bash
curl -X POST 'https://your-domain.com/feishu/approval/callback' \
-H 'Content-Type: application/json' \
-d '{
  "type": "event_callback",
  "event_id": "test_event_001",
  "event": {
    "type": "approval_instance",
    "status": "APPROVED",
    "approval_code": "7C468A54-8745-2245-9675-08654A59C265",
    "instance_code": "81D31358-93AF-92C6-7425-01A5D67C4E71",
    "user_id": "ou_xxx",
    "open_id": "ou_xxx"
  }
}'
```

## ğŸ“ æ—¥å¿—è¾“å‡º

å®¡æ‰¹äº‹ä»¶å¤„ç†æ—¶ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼š

```
================================================================================
ğŸ“¨ æ”¶åˆ°å®¡æ‰¹äº‹ä»¶å›è°ƒ
   æ—¶é—´: 2025-10-27 14:30:00
âœ… æ”¶åˆ°å®¡æ‰¹é€šè¿‡äº‹ä»¶
ğŸ“‹ å®¡æ‰¹ä¿¡æ¯:
   å®¡æ‰¹å®šä¹‰: 7C468A54-8745-2245-9675-08654A59C265
   å®ä¾‹ç¼–ç : 81D31358-93AF-92C6-7425-01A5D67C4E71
   ç”³è¯·äºº: ou_xxx / ou_xxx
ğŸ“… åˆ›å»ºè¯·å‡æ—¥å†:
   ç”¨æˆ·: ou_xxx
   å¼€å§‹: 2025-10-27 (1761532800)
   ç»“æŸ: 2025-10-28 (1761619200)
âœ… è¯·å‡æ—¥å†åˆ›å»ºæˆåŠŸ: 6962888606377328652
ğŸ“Š å¤„ç†ç»“æœ: {'status': 'success', 'message': 'è¯·å‡æ—¥å†åˆ›å»ºæˆåŠŸ', 'calendar_event_id': '6962888606377328652'}
================================================================================
```

## ğŸ” æ•…éšœæ’æŸ¥

### 1. å®¡æ‰¹é€šè¿‡ä½†æ²¡æœ‰åˆ›å»ºæ—¥å†

**å¯èƒ½åŸå› **:
- å®¡æ‰¹è¡¨å•å­—æ®µä¸åŒ…å«è¯·å‡æ—¶é—´ä¿¡æ¯
- å­—æ®µ ID æˆ–åç§°æ— æ³•è¯†åˆ«
- æƒé™ä¸è¶³

**æ’æŸ¥æ­¥éª¤**:
```bash
# æŸ¥çœ‹æ—¥å¿—
docker logs agent2im-scheduler -f

# æ£€æŸ¥å®¡æ‰¹è¯¦æƒ… API
curl -X GET 'https://open.feishu.cn/open-apis/approval/v4/instances/{instance_code}' \
-H 'Authorization: Bearer {token}'
```

### 2. æ—¥å† API è¿”å›é”™è¯¯

**å¸¸è§é”™è¯¯**:

- `code=190014`: æ—¶é—´å‚æ•°é”™è¯¯
  - æ£€æŸ¥ `start_time` æ˜¯å¦æ—©äº `end_time`
  - ç¡®è®¤æ—¶é—´æˆ³æ ¼å¼æ­£ç¡®ï¼ˆç§’çº§ï¼‰

- `code=9499`: Bad Request
  - Token å¯èƒ½å·²è¿‡æœŸ
  - æ£€æŸ¥æƒé™é…ç½®
  - éªŒè¯æ—¶é—´æ ¼å¼

### 3. é‡å¤å¤„ç†é—®é¢˜

ç³»ç»Ÿä½¿ç”¨ `event_id` è¿›è¡Œå¹‚ç­‰æ€§æ§åˆ¶ï¼Œç›¸åŒäº‹ä»¶åªä¼šå¤„ç†ä¸€æ¬¡ã€‚

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å®¡æ‰¹æ¨¡æ¿è®¾è®¡

**æ¨èç»“æ„**:
```
å®¡æ‰¹åç§°: è¯·å‡ç”³è¯·
è¡¨å•å­—æ®µ:
  - è¯·å‡ç±»å‹: å•é€‰ï¼ˆå¹´å‡/ç—…å‡/äº‹å‡ï¼‰
  - è¯·å‡æ—¶é—´: æ—¥æœŸåŒºé—´ï¼ˆstart_time/end_timeï¼‰
  - è¯·å‡å¤©æ•°: æ•°å­—ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
  - è¯·å‡åŸå› : å¤šè¡Œæ–‡æœ¬
```

### 2. æ—¶é—´æ ¼å¼

æ”¯æŒä»¥ä¸‹æ—¶é—´æ ¼å¼ï¼š
- `YYYY-MM-DD` - ä¾‹å¦‚: `2025-10-27`
- `YYYY-MM-DD HH:MM:SS` - ä¾‹å¦‚: `2025-10-27 00:00:00`
- æ—¶é—´æˆ³ï¼ˆç§’ï¼‰ - ä¾‹å¦‚: `1761532800`

### 3. ç›‘æ§å’Œå‘Šè­¦

å»ºè®®é…ç½®ï¼š
- å®¡æ‰¹äº‹ä»¶å¤„ç†å¤±è´¥å‘Šè­¦
- æ—¥å†åˆ›å»ºå¤±è´¥å‘Šè­¦
- å®šæœŸæ£€æŸ¥äº‹ä»¶å¤„ç†æ—¥å¿—

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é£ä¹¦å®¡æ‰¹ API](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/approval-v4/instance/list)
- [é£ä¹¦æ—¥å† API](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/calendar-v4/timeoff_event/create)
- [äº‹ä»¶è®¢é˜…](https://open.feishu.cn/document/ukTMukTMukTM/uUTNz4SN1MjL1UzM)

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. æ—¥å¿—è¾“å‡º
2. é£ä¹¦å¼€æ”¾å¹³å°äº‹ä»¶æ¨é€æ—¥å¿—
3. API å“åº”é”™è¯¯ä¿¡æ¯

